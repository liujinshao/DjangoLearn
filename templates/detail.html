{% extends "template1.html" %}

{% block title %}
<title>详情</title>

{% endblock %}


{% block main %}
<!-- 定义详细目录-->
        <div id="detail">
			<!-- 资源上传者信息 -->
			<div class="res_author">
				<img src="/media/{{ resource.user.axxuser.photo }}"/>
				<span>{{resource.user.axxuser.nickname}}</span><br/>
				<a class="gz" href="javascript:void(0)" >{{msg2}}</a>
				<a href="javascript:void(0)">查看TA的更多资源</a>
			</div>
			<div class="res_det">
				<!-- 资源信息 -->
				<div class="title"> <!-- 主信息-->
					<div class="img">
						<img src="/static/images/txt.svg" />
					</div>
					<div class="cons">
						<div>
							<label>{{resource.keywords}}</label>
						</div>
						<div>
							<label><b>{{resource.create_time}}</b><b> 上传大小：{{resource.size |filesizeformat}}</b></label>
							<span>{{ resource.ext }}</span>

						</div>
					</div>
				</div>
				<div class="desc"> <!-- 信息描述-->
					{{ resource.resource_desc }}
				</div>
				<div class="msg"> <!-- 评价信息-->
                    {% for i in "0"|rjust:5 %}
                        <span {% if forloop.counter <= num  %} class="act"  {% endif %}>★</span>
                    {% endfor %}

				</div>
				<div class="oper"> <!-- 下载操作-->
					<span>所需积分：<b>{{ resource.score }}</b></span>
					<span>下载次数：<b>{{ resource.downloads.count }}</b></span><br/>
					<span>
{#                        onclick="downloads({{ resource.pk }})#}
						<a class="btn" href="/resource/download/{{ resource.pk }}">普通下载</a>
						<a class="btn">迅雷下载</a>
						<a class="btn" >{{msg}}</a>
					</span>
				</div>
			</div>

        </div>
        <div id="comment">
            <div class="title">
                评论：<span>共有<c>{{ comments|length }}</c>条</span>
                <hr />
            </div>
            {% for data in comments %}
             <!--每一条评论 -->
            <div class="cons">
                <div class="img">
                    <img src="/media/{{ data.user.axxuser.photo }}" />
                </div>
                <div class="cmt">
                    <div>
                        <span class="author">{{data.user.axxuser.nickname}}</span>
                        <span class="timer">{{ data.create_time|date:'Y-m-d H:i:s' }}</span>
                        <span class="star">
                           {% for i in "0"|rjust:5 %}
                               <span {% if forloop.counter <= data.star %}class="act"{% endif %}>★</span>
                           {% endfor %}
                        </span>
                    </div>

                    <div class="msg">
                        <dt>{{ data.content }}</dt>
                    </div>
                </div>
            </div>

            {% endfor %}
        </div>

        <!-- 开始评论-->
          <div id="mycomments">
            <div>
                <span>我的评论</span>
                <hr />

                <textarea placeholder="可以留下您的宝贵意见哟"></textarea>
				<b>错误提示信息</b>
                <div class="star"> <!-- 评价信息-->
                    <span n="1" class="act">★</span>
                    <span n="2">★</span>
                    <span n="3">★</span>
                    <span n="4">★</span>
                    <span n="5">★</span>
                </div>
                <a id="commentBtn" class="btn">评论</a>
            </div>

        </div>
{% endblock %}
{% block chat %}
    <!-- 聊天按钮 -->
	<aside id="chat">
		<icon></icon>
		<a href="javascript:void(0);">在线聊天</a>
	</aside>

	<!-- 聊天窗口-->
	<aside id="chat_win">
		<div class="title">在线聊天，按ESC关闭窗口，按Enter提交信息</div>
		<!-- 好友面板 -->
		<div class="frily">
			<!-- 一个好友 -->
			<a href="javascript:void(0)" class="fly">
				<div class='d1'>
					<img class="chat_img" src='/static/images/coms.jpg' />
					<!-- 显示消息数量 -->
					<div class="msg">99+</div>
				</div>
				<div class='d2'>
					<span>藏三僧</span>
				</div>
			</a>

			<a href="javascript:void(0)" class="fly">
				<div class='d1'>
					<img class="chat_img" src='/static/images/coms.jpg' />
					<!-- 显示消息数量 -->
					<div class="msg">64</div>
				</div>
				<div class='d2'>
					<span>─╀0vЁ灬忽必烈</span>
				</div>
			</a>

			<a href="javascript:void(0)" class="fly">
				<div class='d1'>
					<img class="chat_img" src='/static/images/coms.jpg' />
					<!-- 显示消息数量,如果没有，则不显示 -->
					<div class="msg zero">0</div>
				</div>
				<div class='d2'>
					<span>─╀0vЁ灬忽必烈</span>
				</div>
			</a>

			<!-- 获取更多 -->
			<a class="more" href="javascript:void(0)">加载更多</a>

		</div>
		<!-- 聊天面板 -->
		<div class="chat_cs">
			<!-- 聊天内容 -->
			<div class="content">
				<!-- 获取更多 -->
				<a class="more" href="javascript:void(0)">加载更多</a>

				<!--  发信息 -->
				<div class="right">
					<div class='d1'>
						<img class="chat_img" src='/static/images/coms.jpg' />
					</div>
					<div class='d2'>
						<span>藏三僧</span><time>2019-10-16 08:58:34</time>
						<p>
							<span>你好,您的资源能够免费发我一份吗，我这边没有积分了，但是现在非常需要这份资源，如果方便的话，还请送我一份，好吗?</span>
						</p>
					</div>
				</div>

				<!--  收信息 -->
				<div class="left">
					<div class='d1'>
						<img class="chat_img" src='/static/images/user.jpg' />
					</div>
					<div class='d2'>
						<span>─╀0vЁ灬残夜</span><time>2019-10-16 08:58:34</time>
						<p>
							<span>不好意思啊，资料我自己没有进行存储</span>
						</p>
					</div>
				</div>
				<!--  收信息 -->
				<div class="left">
					<div class='d1'>
						<img class="chat_img" src='/static/images/user.jpg' />
					</div>
					<div class='d2'>
						<span>─╀0vЁ灬残夜</span><time>2019-10-16 08:58:34</time>
						<p>
							<span>不好意思啊，资料我自己没有进行存储</span>
						</p>
					</div>
				</div>
				<!--  收信息 -->
				<div class="left">
					<div class='d1'>
						<img class="chat_img" src='/static/images/user.jpg' />
					</div>
					<div class='d2'>
						<span>─╀0vЁ灬残夜</span><time>2019-10-16 08:58:34</time>
						<p>
							<span>不好意思啊，资料我自己没有进行存储</span>
						</p>
					</div>
				</div>

			</div>
			<!-- 回复 -->
			<div class="reply">
				<textarea id="editer"></textarea>
			</div>

		</div>
	</aside>
{% endblock %}
	

{% block script %}
{#    不能读取这个包，原因不明，放开会因为读不到非常卡#}
<script src="/static/js/jquery.mCustomScrollbar.js"></script>
<script>
function downloads(pk) {
        console.log("点击了异步校验")
        // 通过异步请求、去完成 下载的校验工作
    $.ajax({
        url:'/resource/download/' + pk + '/check',
        type:"get",
        dataType:"json",
        success:function (data) {
                console.log(data)
        }
    })
}
$(function(){
            //异步请求  收藏界面
            var resource_id="{{ resource.id }}"
            $(".oper a:last").click(function () {
                $.ajax({
                    url:"/resource/favorite",
                    method: "post",
                    data:{resource_id:resource_id},
                    dataType:"json",
                    success:function (data) {
                        console.log(data.msg)
                        $(".oper a:last").text(data.msg)
                        if(data.msg=="收藏"){
                            alert("已经取消收藏")
                        }
                    },
                })

            })
            //异步关注
            var resource_user_id={{ resource.user_id }}
            $(".res_author a:first").click(function () {
                console.log("点击了关注",resource_user_id)
                $.ajax({
                    url:"/extra/attention",
                    method:"post",
                    dataType:"json",
                    data:{resource_user_id:resource_user_id},
                    success:function (data) {
                        console.log(data.msg2)
                        $(".res_author a:first").text(data.msg2)
                    }
                })
            })


            //点击前端显示星级
			var n=1
			$("#mycomments .star span").on("click",function(){
				// console.log("=======")
				$(this).addClass("act").prevAll().addClass("act")
				$(this).nextAll().removeClass("act")
				n=$(this).attr("n")
				console.log(n)
			})
            //点击异步请求评论
			$('#commentBtn').on("click",function(event){
				var content=$(this).prevAll("textarea").val()
				console.log(content,n,resource_id)
                $.ajax({
                    url:"/resource/comment",
                    method:"post",
                    dataType: "json",
                    data:{
                        content:content,star:n,resource_id:resource_id
                    },
                    success:function (data) {
                        if (data.msg) {
                            console.log(data.msg)
                            alert(data.msg)
                        } else {
                            let html = `<div class="cons">
                            <div class="img">
                                <img src=""/>
                            </div>
                            <div class="cmt">
                                <div>
                                    <span class="author"></span>
                                    <span class="timer"></span>
                                    <span class="star">
                                        <span>★</span>
                                        <span>★</span>
                                        <span>★</span>
                                        <span>★</span>
                                        <span>★</span>
                                    </span>
                                </div>

                                <div class="msg">
                                    <dt></dt>
                                </div>
                            </div>
                        </div>
                    `
                            // 将 html 转成 jquery对象
                            html = $(html)
                            html.find("img").attr("src", "/media/" + data.photo)
                            html.find(".author").text(data.nickname)
                            let create_time = data.create_time.replace("T", " ")
                            let index = create_time.lastIndexOf(".")
                            create_time = create_time.substring(0, index)
                            html.find(".timer").text(create_time)
                            html.find(`.star span:lt(${data.star})`).addClass("act")

                            html.find(".msg dt").text(data.content)

                            // 将 html 追加为 第一条评论
                            $("#comment .title").after(html)
                            // 追加评论数量
                            var num = $("#comment .title c").text()

                            $("#comment .title c").text(num - -1)
                        }
                            }
                })


				$(this).prevAll("textarea").val("")
			})

        	$("#chat").on('click', function(){
				var tag = $(this);
				tag.hide();
				$('#chat_win').show()
				if(!tag.data('scroll')) {
					vm = $(".content , .frily").mCustomScrollbar({
						theme:"dark-thin",
					});
					// 初始化滚动条放到尾部
					$(".content").mCustomScrollbar('scrollTo', 'bottom');
					tag.data('scroll', true);
				}

			})
			$(document).on('keydown', function(e){
				if (e.keyCode==27){
					$('#chat_win').hide()
					$("#chat").show()
				}
			})
			$("#editer").keydown(function(e){
				if (e.keyCode ==13) {
					msg = $(".chat_cs .right:first").clone()
					msg.find("span:last").text($(this).val())
					$(".content").append(msg)
					// 清除 输入的内容
					$(this).val('').focus()
					//刷新滚动条
					//$(".content").mCustomScrollbar('update')
					$(".content").mCustomScrollbar('destroy')
					$(".content").mCustomScrollbar({theme:"dark-thin"})
					$(".content").mCustomScrollbar('scrollTo', 'bottom', {
						scrollInertia:80
					});

				}
			})


})

</script>

{% endblock %}