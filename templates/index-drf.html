<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" type="text/css" href="./css/index.css"/>
    <title>首页</title>
	<script src="js/jquery-3.2.1.min.js"></script>
	
</head>
<body>
    <!-- 登录弹出层 -->
    <div class="cvs" style="display:none" id="cvs2_logon">
        <div class="newModWin">
            <div class="title">登录爱下下账号</div>
            <div class="close" id="cvs2_close">X</div>

            <div class="logWin">
                <form action="" method="post">
                    <input type="text" class="inp user" name="name" autocomplete="off" placeholder="请输入用户名" />
                    <input type="password" class="inp pass" name="password" autocomplete="off" placeholder="请输入密码" />
                    <!-- <b> 显示登录失败错误信息 -->
					<b class="msg"></b>
					<a href="findpass.html" class="find_pass">忘记密码，立即找回</a>
                    <input type="submit" class="su_btn" value="登录" />
                    <a href="register.html" class="reg">注册</a>
					<p class="third">
						<a class="zfb"><span>支付宝</span></a>
						<a class="wx"><span>微信</span></a>
						<a class="qq"><span>QQ</span></a>
					</p>
                </form>
            </div>
        </div>
    </div>
	
	<div class="header">
		<div class="lf">
			<a href="index.html">首页</a>
			<a href="bbs.html">论坛</a>
			<a href="upload.html">上传资料</a>
		</div>
		
		<div class="rf">
			<a href="personal.html">个人信息</a>
			<a href="shoucang.html">我的收藏</a>
			<a href="point.html">积分</a>
			<a>退出登录</a>
		</div>
	</div>

    <!-- 网站头信息-->
    <div id="nav">
        <div id="search">
            <input type="text" name="search" autocomplete="off"/><a class="search btn">搜索</a>
        </div>

        <div id="logon">
            <div class="cons">
                欢迎光临爱下下！
            </div>
            <div class="opers">
				<a class="btn" href="upload.html">上传资料</a>
            </div>
        </div>

        <div id="login">
            <a href="javascript:void(0)">点击登录</a>
        </div>
    </div>

    <!-- 网站主体 -->
    <div id="main">
        <!-- 定义一个条目-->
		<div class="panigation">
			<a>首页</a>
			<a>&lt;上一页</a>
			
			<a>下一页&gt;</a>
			<a>尾页</a>
			<select>
				
			</select>
		</div>
    </div>
	
	
	<script>
		var first_url = 'http://127.0.0.1:8000/user/resource/'; 
		var page = 1 ;
		var total_page = 0 ;
		$(function(){
			show_msg(first_url);
			// 给搜索按钮绑定单击事件
			$(".search.btn").on("click", function() {
				// 获取搜索的内容
				var search = $(this).prev().val()
				// 调用 接口、完成数据的搜索
				first_url = first_url + "?search=" + search ;
				page = 1 ; // 重置页面为 第一页
				show_msg(first_url)	
			})
			
			$(".panigation select").on("change", function(){
				// 获取下拉列表 被选中的 页面
				page = $(this).find("option:selected").val(); 
				// 进行 对应页面数据的查询
				var url = "" ;
				if (first_url.indexOf("?") != -1) {
					url = first_url + "&page=" + page ;
				}else{
					url = first_url + "?page=" + page ;
				}
				
				show_msg(url)
			});
		})
		
		
		function to(url, k) {
			if (k == 1) {
				page++ ;
			}else if (k== -1) {
				page-- ;
			}else if (k == 'F') {
				page = 1
			}else if (k == 'L') {
				page = total_page ;
			}
			// 调用接口、显示对应的页面的数据
			show_msg(url)
		}
		
		
		
		function show_ext(ext) {
			let svg_imgs = ["doc", "docx", "exe", "pdf", "ppt", "rar", "txt", "xlsx", "zip"]
			
			let flag = false ; // 代表不存在后缀
			svg_imgs.forEach(function(row, index) {
				if (row == ext) {
					flag = true ;
					return false ; // 退出循环
				}
			})
			return flag ? ext: "unknow" ;
		}
		
		
		
		function show_msg(url) {
			$.ajax({
				url: url, 
				type: 'GET',
				dataType: 'json',
				success:function(data){
					$("#main").find(".pro").remove();
					// 显示数据
					var results = data.results ;
					var html = '';
					results.forEach(function(row, index){
						html += `<div class="pro">
								   <div class="img">
									   <img src="./images/${show_ext(row.ext)}.svg" />
								   </div>
									<div class="cs">
										<div class="up">
											<a href="detai.html">${row.resource_name}</a>
										</div>
										<div class="down">
											<span>${row.upload_time}</span>
											<span>${row.user.info}</span>
										</div>
									</div>
									<div class="arr">
										<span>积分:<b>${row.score}</b></span>
										<span>访问次数:<b>5</b></span>
									</div>
								</div>`
					})
					
					// 将 html 追加 到 
					$("#main").prepend(html);
					
					
					var total = data.count
					total_page = Math.floor((data.count - 1)/5) + 1 ;
					// 处理 分页逻辑 
					
					$(".panigation").find("a:first").attr("href", "javascript:to('" + first_url + "', 'F')");
					
					per_page =  data.previous ? "javascript:to('" +data.previous+ "', -1)" : "javascript:void(0);"
					
					$(".panigation").find("a:eq(1)").attr("href", per_page);
					
					next_page = data.next? "javascript:to('" + data.next+ "', 1)" : "javascript:void(0);"
					
					$(".panigation").find("a:eq(2)").attr("href", next_page);
					
					
					
					var last_page = "" ;
					if (first_url.indexOf("?") != -1) {
						last_page = "javascript:to('" + first_url + "&page=" + total_page + "', 'L')";
					}else{
						last_page = "javascript:to('" + first_url + "?page=" + total_page + "', 'L')";
					}
					
					$(".panigation").find("a:last").attr("href", last_page);
					
					var options = "" ;
					for(let i=1 ; i<= total_page ; i++) {
						// 获取当前页码
						if (page == i) {
							options += `<option value='${i}' selected>${i}/${total_page}</option>`
						}else{
							options += `<option value='${i}'>${i}/${total_page}</option>`
						}
					}
					$(".panigation select").html(options);
					
				}
			})
		
		}
		
	</script>
</body>

</html>